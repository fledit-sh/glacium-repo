Below is a **complete reference specification** for the high‑level Glacium pipeline API.
Copy it verbatim into your coding agent’s prompt; it contains every public class, method, argument, return type, side effect, and behavioural contract.

---

## 1. Overview

```text
Module: glacium.pipeline
Primary classes: Project, Pipeline
Note: the former ``Run`` class has been renamed to ``Project``.
Purpose: Declarative, chainable DSL for defining and executing aerodynamic
         simulation cases and study suites without exposing low‑level managers.
All methods return self (or a new object) to enable fluent chaining,
except for pure accessors such as `preview`, `execute`, `to_dict`, etc.
```

---

## 2. `class Project`

| Method                      | Signature                                                                                               | Behaviour                                                                                                                 |                                                                       |                              |                |                                                                        |
| --------------------------- | ------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------- | ---------------------------- | -------------- | ---------------------------------------------------------------------- |
| `__init__`                  | \`Run(\*, airfoil: str                                                                                  | None = None, parameters: dict\[str, Any]                                                                                  | None = None, jobs: list\[str]                                         | None = None, tags: set\[str] | None = None)\` | Create an empty or pre‑populated run. No validation is performed here. |
| `select_airfoil`            | `.select_airfoil(name: str) → Run`                                                                      | Sets/overwrites the airfoil identifier.                                                                                   |                                                                       |                              |                |                                                                        |
| `set`                       | `.set(key: str, value: Any) → Run`                                                                      | Inserts or replaces one scalar parameter.                                                                                 |                                                                       |                              |                |                                                                        |
| `set_bulk`                  | `.set_bulk(params: Mapping[str, Any]) → Run`                                                            | Batch insert/replace multiple parameters.                                                                                 |                                                                       |                              |                |                                                                        |
| `add_job`                   | `.add_job(name: str) → Run`                                                                             | Appends a single job string to the job list (duplicates allowed).                                                         |                                                                       |                              |                |                                                                        |
| `jobs`                      | `.jobs(names: Iterable[str]) → Run`                                                                     | Extends the job list with all names provided.                                                                             |                                                                       |                              |                |                                                                        |
| `clear_jobs`                | `.clear_jobs() → Run`                                                                                   | Removes **all** previously added jobs.                                                                                    |                                                                       |                              |                |                                                                        |
| `tag`                       | `.tag(label: str) → Run`                                                                                | Adds one label to the `tags` set.                                                                                         |                                                                       |                              |                |                                                                        |
| `tags`                      | `.tags(labels: Iterable[str]) → Run`                                                                    | Adds many labels.                                                                                                         |                                                                       |                              |                |                                                                        |
| `remove_tag`                | `.remove_tag(label: str) → Run`                                                                         | Delete a single tag if present.                                                                                           |                                                                       |                              |                |                                                                        |
| `depends_on`                | `.depends_on(other: Run) → Run`                                                                         | Declares a hard dependency; current run will not execute until `other` completes successfully. Multiple calls accumulate. |                                                                       |                              |                |                                                                        |
| `clone`                     | `.clone(deep: bool = True) → Run`                                                                       | Returns an independent copy (deep copy by default). Does **not** duplicate dependency edges.                              |                                                                       |                              |                |                                                                        |
| `preview`                   | \`.preview(fmt: Literal\["str","dict","json","yaml"] = "str") → str                                     | dict\`                                                                                                                    | Human‑readable snapshot of airfoil, params, jobs, tags, dependencies. |                              |                |                                                                        |
| `execute`                   | `.execute(*, dry_run: bool = False) → RunResult`                                                        | Shortcut: wraps the run in a transient Pipeline and executes it. Returns a result object (opaque to this API).            |                                                                       |                              |                |                                                                        |
| `validate`                  | `.validate() → None`                                                                                    | Raises `ValueError` if airfoil missing, parameters invalid types, zero jobs, or circular dependency.                      |                                                                       |                              |                |                                                                        |
| `to_dict`                   | `.to_dict() → dict`                                                                                     | Serialises **only** declarative data (`airfoil`, `parameters`, `jobs`, `tags`, dependency UUIDs).                         |                                                                       |                              |                |                                                                        |
| `to_json`                   | `.to_json(indent: int = 2) → str`                                                                       | Convenience JSON wrapper around `to_dict`.                                                                                |                                                                       |                              |                |                                                                        |
| `to_yaml`                   | `.to_yaml() → str`                                                                                      | YAML dump of `to_dict`.                                                                                                   |                                                                       |                              |                |                                                                        |
| `from_dict` *(classmethod)* | `Run.from_dict(data: dict) → Run`                                                                       | Inverse of `to_dict`, dependencies still represented by UUID placeholders.                                                |                                                                       |                              |                |                                                                        |
| **Properties**              | `id: str` (immutable UUIDv4), `airfoil`, `parameters`, `jobs`, `tags`, `dependencies` (set of Run IDs). |                                                                                                                           |                                                                       |                              |                |                                                                        |

---

## 3. `class Pipeline`

| Method                        | Signature                                                                                                      | Behaviour                                                                                                                        |                                                                                                                          |                                                                                              |                                                                                                                                                                                         |
| ----------------------------- | -------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------ | -------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `__init__`                    | \`Pipeline(runs: Iterable\[Run]                                                                                | None = None)\`                                                                                                                   | Creates an empty pipeline or pre‑loads runs.                                                                             |                                                                                              |                                                                                                                                                                                         |
| `add`                         | `.add(run: Run) → Pipeline`                                                                                    | Appends one run. Duplicate IDs raise `ValueError`.                                                                               |                                                                                                                          |                                                                                              |                                                                                                                                                                                         |
| `add_many`                    | `.add_many(runs: Iterable[Run]) → Pipeline`                                                                    | Vectorised `add`.                                                                                                                |                                                                                                                          |                                                                                              |                                                                                                                                                                                         |
| `remove`                      | \`.remove(run\_or\_id: Run                                                                                     | str) → Pipeline\`                                                                                                                | Removes by object or ID. Also deletes dependency edges targeting it.                                                     |                                                                                              |                                                                                                                                                                                         |
| `repeat`                      | `.repeat(template: Run, param: str, values: Iterable[Any], *, tag_format: str = "{param}={value}") → Pipeline` | Clones `template` for every `value`, sets the parameter, auto‑tags each run, and appends them.                                   |                                                                                                                          |                                                                                              |                                                                                                                                                                                         |
| `param_grid`                  | \`.param\_grid(\*, airfoils: Sequence\[str]                                                                    | None = None, common: Mapping\[str, Any]                                                                                          | None = None, jobs: Sequence\[str]                                                                                        | None = None, \*\*param\_axes: Sequence\[Any]) → Pipeline\`                                   | Generates the Cartesian product of all `param_axes`. Each combination becomes a run. `common` merged into every run’s parameter dict. Optional `jobs` added to every run. returns self. |
| `combine`                     | `.combine(other: Pipeline) → Pipeline`                                                                         | Union of runs; conflicting IDs raise.                                                                                            |                                                                                                                          |                                                                                              |                                                                                                                                                                                         |
| `filter`                      | `.filter(predicate: Callable[[Run], bool]) → Pipeline`                                                         | Returns **new** pipeline of runs meeting `predicate`.                                                                            |                                                                                                                          |                                                                                              |                                                                                                                                                                                         |
| `tags`                        | \`.tags(labels: str                                                                                            | Iterable\[str]) → Pipeline\`                                                                                                     | Shortcut for `.filter(lambda r: <match tags>)`.                                                                          |                                                                                              |                                                                                                                                                                                         |
| `preview`                     | \`.preview(fmt: Literal\["table","dict","json","yaml"] = "table", max\_rows: int                               | None = 20) → str                                                                                                                 | dict\`                                                                                                                   | Tabular or structured overview of all runs (ID, tags, airfoil, param keys, job count, deps). |                                                                                                                                                                                         |
| `execute`                     | `.execute(*, concurrency: int = 1, stop_on_error: bool = False, dry_run: bool = False) → list[RunResult]`      | Validates all runs, topologically sorts by dependencies, then dispatches jobs. Handles local thread pool when `concurrency > 1`. |                                                                                                                          |                                                                                              |                                                                                                                                                                                         |
| `save_layout`                 | \`.save\_layout(path: str, \*, format: Literal\["yaml","json"]                                                 | None = None, include\_results: bool = False) → Path\`                                                                            | Serialises **declarative** content (plus optional result digests) to disk. Auto‑infers format from extension if omitted. |                                                                                              |                                                                                                                                                                                         |
| `load_layout` *(classmethod)* | \`Pipeline.load\_layout(path: str, \*, format: Literal\["yaml","json"]                                         | None = None) → Pipeline\`                                                                                                        | Inverse of `save_layout`.                                                                                                |                                                                                              |                                                                                                                                                                                         |
| `size`                        | `.size() → int`                                                                                                | Number of runs. (Also supports builtin `len(pipe)`).                                                                             |                                                                                                                          |                                                                                              |                                                                                                                                                                                         |
| `dependency_graph`            | `.dependency_graph() → networkx.DiGraph`                                                                       | Returns a directed acyclic graph of Run IDs for advanced schedulers; networkx is optional dependency.                            |                                                                                                                          |                                                                                              |                                                                                                                                                                                         |
| `validate`                    | `.validate() → None`                                                                                           | Verifies uniqueness of IDs, no circular dependencies across the whole set, and every run passes its own `validate()`.            |                                                                                                                          |                                                                                              |                                                                                                                                                                                         |
| **Magic / dunder**            | `__iter__` (yields runs in insertion order), `__len__`, `__getitem__(id_or_index)`, `__repr__` (brief).        |                                                                                                                                  |                                                                                                                          |                                                                                              |                                                                                                                                                                                         |

---

## 4. Exceptions & Result Types

```python
class RunResult(NamedTuple):
    run_id: str
    success: bool
    elapsed: float          # seconds
    artifacts: dict[str, Path]  # filenames generated
    error: Exception | None
```

* `Run.validate` & `Pipeline.validate` raise `ValueError`, `TypeError`, or `RuntimeError` with explicit messages.
* `Pipeline.execute` collects results even when `stop_on_error = False`; otherwise aborts on first failure.

---

## 5. Helper Functions (module level)

| Function | Signature                                                                                                 | Notes                                                        |                                                                   |                                                            |                                                                   |
| -------- | --------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ | ----------------------------------------------------------------- | ---------------------------------------------------------- | ----------------------------------------------------------------- |
| `sweep`  | `sweep(base: Run, param: str, values: Iterable[Any], *, tag_format: str = "{param}={value}") → list[Run]` | Stand‑alone variant of `repeat` for list comprehension fans. |                                                                   |                                                            |                                                                   |
| `grid`   | \`grid(\*, airfoils: Sequence\[str]                                                                       | None = None, common: Mapping\[str, Any]                      | None = None, jobs: Sequence\[str]                                 | None = None, \*\*param\_axes: Sequence\[Any]) → Pipeline\` | Stand‑alone variant of `param_grid` returning a **new** pipeline. |
| `load`   | `load(path: str) → Pipeline`                                                                              | Shorthand for `Pipeline.load_layout`.                        |                                                                   |                                                            |                                                                   |
| `run`    | \`run(layout: str                                                                                         | PathLike, \*\*execute\_kwargs) → list\[RunResult]\`          | One‑liner CLI helper: load, preview, execute, and return results. |                                                            |                                                                   |

---

## 6. Behavioural Guarantees

1. **Immutability of IDs**: every `Run` receives a UUIDv4 at construction; cloning generates a new UUID.
2. **Chainability**: all mutator methods return `self` (or a new object in the case of `clone` or `filter`).
3. **Validation first**: `Pipeline.execute()` calls `validate()` on itself and each run before execution.
4. **Deterministic order**: `execute()` follows topological order respecting dependencies; runs at the same depth are scheduled FIFO unless `concurrency > 1`.
5. **Side‑effect‑free serialization**: `to_dict` / `save_layout` emit **only** declarative state—never attached results unless `include_results=True`.
6. **Library‑agnostic jobs**: jobs are passed as plain strings; mapping to concrete job classes happens internally in the lower layer, outside this API.

---

## 7. Minimal Example (copy‑pasta ready)

```python
from glacium.pipeline import Run, Pipeline

# AoA sweep around a single airfoil
template = (
    Run()
    .select_airfoil("NACA0012")
    .set_bulk({"CHORD_LENGTH": 0.45, "Re": 1.5e6})
    .jobs(["XFOIL_ANALYSIS"])
)

pipe = Pipeline().repeat(template, "AoA", [-2, 0, 2, 4, 6])
pipe.preview()
results = pipe.execute(concurrency=3)
pipe.save_layout("aoa_sweep.yaml")
```

---

**Hand this specification to your coding agent**—it contains every public surface the implementation must satisfy.
