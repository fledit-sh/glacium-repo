#!/bin/sh
rm -f .solvercmd.out
export FLUENT_EXE="C:\Program Files\ANSYS Inc\v251\fluent\ntbin\win64\fluent"
export FLUENT_INTEL_MPI_VERSION="2018"
export NTI_DATA="C:/Program Files/ANSYS Inc/v251/fensapice/data"
export NTI_PATH="C:\Program Files\ANSYS Inc\v251\fensapice\bin\"
export Path="C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/;C:\Program Files\ANSYS Inc\v251\fluent\fluent25.1.0\multiport\mpi_wrapper\win64\intel\;C:\Program Files\ANSYS Inc\v251\fensapice\bin\;$Path"

export FLUENT_H5=
export FLUENT_NCPU={{ N_CPU }}
export FLUENT_NCPU_MESHING={{ N_CPU }}
export FLUENT2FENSAP_PARAMS=""


if [ -f .restart ]; then
  STEP=`cat .restart`
else
  STEP=0
fi
# Remove files for a clean solver start
if [ $STEP -eq 0 ]; then
rm -f roughness.dat
rm -f soln.fensap.000001
rm -f surface.dat.fensap.000001
rm -f hflux.dat.fensap.000001
rm -f gmres.out.fensap.000001
rm -f out.fensap.000001
rm -f converg.fensap.000001
rm -f fensapstop.txt.fensap.000001
rm -f droplet.drop.000001
rm -f crystal.drop.000001
rm -f vapor.drop.000001
rm -f gmres.out.drop.000001
rm -f out.drop.000001
rm -f converg.drop.000001
rm -f fensapstop.txt.drop.000001
rm -f swim.log.ice.000001
rm -f map.grid.ice.000001
rm -f timebc.dat.ice.000001
rm -f ice.ice.000001.stl
rm -f ice.ice.000001.tin
rm -f ice.grid.ice.000001
rm -f iceconv.dat.ice.000001
rm -f swimsol.ice.000001
rm -f grid.ice.000002
rm -f ice3dstop.txt.ice.000001
rm -f fensapstop.txt.griddisp.000001
rm -f out.griddisp.000001
rm -f converg.griddisp.000001
rm -f GCI.grid.disp
rm -f out.remesh.griddisp.000001
rm -f soln.fensap.000002
rm -f surface.dat.fensap.000002
rm -f hflux.dat.fensap.000002
rm -f gmres.out.fensap.000002
rm -f out.fensap.000002
rm -f converg.fensap.000002
rm -f fensapstop.txt.fensap.000002
rm -f droplet.drop.000002
rm -f crystal.drop.000002
rm -f vapor.drop.000002
rm -f gmres.out.drop.000002
rm -f out.drop.000002
rm -f converg.drop.000002
rm -f fensapstop.txt.drop.000002
rm -f swim.log.ice.000002
rm -f map.grid.ice.000002
rm -f timebc.dat.ice.000002
rm -f ice.ice.000002.stl
rm -f ice.ice.000002.tin
rm -f ice.grid.ice.000002
rm -f iceconv.dat.ice.000002
rm -f swimsol.ice.000002
rm -f grid.ice.000003
rm -f ice3dstop.txt.ice.000002
rm -f fensapstop.txt.griddisp.000002
rm -f out.griddisp.000002
rm -f converg.griddisp.000002
rm -f out.remesh.griddisp.000002
rm -f soln.fensap.000003
rm -f surface.dat.fensap.000003
rm -f hflux.dat.fensap.000003
rm -f gmres.out.fensap.000003
rm -f out.fensap.000003
rm -f converg.fensap.000003
rm -f fensapstop.txt.fensap.000003
rm -f droplet.drop.000003
rm -f crystal.drop.000003
rm -f vapor.drop.000003
rm -f gmres.out.drop.000003
rm -f out.drop.000003
rm -f converg.drop.000003
rm -f fensapstop.txt.drop.000003
rm -f swim.log.ice.000003
rm -f map.grid.ice.000003
rm -f timebc.dat.ice.000003
rm -f ice.ice.000003.stl
rm -f ice.ice.000003.tin
rm -f ice.grid.ice.000003
rm -f iceconv.dat.ice.000003
rm -f swimsol.ice.000003
rm -f grid.ice.000004
rm -f ice3dstop.txt.ice.000003
rm -f fensapstop.txt.griddisp.000003
rm -f out.griddisp.000003
rm -f converg.griddisp.000003
rm -f out.remesh.griddisp.000003
rm -f soln.fensap.000004
rm -f surface.dat.fensap.000004
rm -f hflux.dat.fensap.000004
rm -f gmres.out.fensap.000004
rm -f out.fensap.000004
rm -f converg.fensap.000004
rm -f fensapstop.txt.fensap.000004
rm -f droplet.drop.000004
rm -f crystal.drop.000004
rm -f vapor.drop.000004
rm -f gmres.out.drop.000004
rm -f out.drop.000004
rm -f converg.drop.000004
rm -f fensapstop.txt.drop.000004
rm -f swim.log.ice.000004
rm -f map.grid.ice.000004
rm -f timebc.dat.ice.000004
rm -f ice.ice.000004.stl
rm -f ice.ice.000004.tin
rm -f ice.grid.ice.000004
rm -f iceconv.dat.ice.000004
rm -f swimsol.ice.000004
rm -f grid.ice.000005
rm -f ice3dstop.txt.ice.000004
rm -f fensapstop.txt.griddisp.000004
rm -f out.griddisp.000004
rm -f converg.griddisp.000004
rm -f out.remesh.griddisp.000004
rm -f soln.fensap.000005
rm -f surface.dat.fensap.000005
rm -f hflux.dat.fensap.000005
rm -f gmres.out.fensap.000005
rm -f out.fensap.000005
rm -f converg.fensap.000005
rm -f fensapstop.txt.fensap.000005
rm -f droplet.drop.000005
rm -f crystal.drop.000005
rm -f vapor.drop.000005
rm -f gmres.out.drop.000005
rm -f out.drop.000005
rm -f converg.drop.000005
rm -f fensapstop.txt.drop.000005
rm -f swim.log.ice.000005
rm -f map.grid.ice.000005
rm -f timebc.dat.ice.000005
rm -f ice.ice.000005.stl
rm -f ice.ice.000005.tin
rm -f ice.grid.ice.000005
rm -f iceconv.dat.ice.000005
rm -f swimsol.ice.000005
rm -f grid.ice.000006
rm -f ice3dstop.txt.ice.000005
rm -f fensapstop.txt.griddisp.000005
rm -f out.griddisp.000005
rm -f converg.griddisp.000005
rm -f out.remesh.griddisp.000005
rm -f soln.fensap.000006
rm -f surface.dat.fensap.000006
rm -f hflux.dat.fensap.000006
rm -f gmres.out.fensap.000006
rm -f out.fensap.000006
rm -f converg.fensap.000006
rm -f fensapstop.txt.fensap.000006
rm -f droplet.drop.000006
rm -f crystal.drop.000006
rm -f vapor.drop.000006
rm -f gmres.out.drop.000006
rm -f out.drop.000006
rm -f converg.drop.000006
rm -f fensapstop.txt.drop.000006
rm -f swim.log.ice.000006
rm -f map.grid.ice.000006
rm -f timebc.dat.ice.000006
rm -f ice.ice.000006.stl
rm -f ice.ice.000006.tin
rm -f ice.grid.ice.000006
rm -f iceconv.dat.ice.000006
rm -f swimsol.ice.000006
rm -f grid.ice.000007
rm -f ice3dstop.txt.ice.000006
rm -f fensapstop.txt.griddisp.000006
rm -f out.griddisp.000006
rm -f converg.griddisp.000006
rm -f out.remesh.griddisp.000006
rm -f soln.fensap.000007
rm -f surface.dat.fensap.000007
rm -f hflux.dat.fensap.000007
rm -f gmres.out.fensap.000007
rm -f out.fensap.000007
rm -f converg.fensap.000007
rm -f fensapstop.txt.fensap.000007
rm -f droplet.drop.000007
rm -f crystal.drop.000007
rm -f vapor.drop.000007
rm -f gmres.out.drop.000007
rm -f out.drop.000007
rm -f converg.drop.000007
rm -f fensapstop.txt.drop.000007
rm -f swim.log.ice.000007
rm -f map.grid.ice.000007
rm -f timebc.dat.ice.000007
rm -f ice.ice.000007.stl
rm -f ice.ice.000007.tin
rm -f ice.grid.ice.000007
rm -f iceconv.dat.ice.000007
rm -f swimsol.ice.000007
rm -f grid.ice.000008
rm -f ice3dstop.txt.ice.000007
rm -f fensapstop.txt.griddisp.000007
rm -f out.griddisp.000007
rm -f converg.griddisp.000007
rm -f out.remesh.griddisp.000007
rm -f soln.fensap.000008
rm -f surface.dat.fensap.000008
rm -f hflux.dat.fensap.000008
rm -f gmres.out.fensap.000008
rm -f out.fensap.000008
rm -f converg.fensap.000008
rm -f fensapstop.txt.fensap.000008
rm -f droplet.drop.000008
rm -f crystal.drop.000008
rm -f vapor.drop.000008
rm -f gmres.out.drop.000008
rm -f out.drop.000008
rm -f converg.drop.000008
rm -f fensapstop.txt.drop.000008
rm -f swim.log.ice.000008
rm -f map.grid.ice.000008
rm -f timebc.dat.ice.000008
rm -f ice.ice.000008.stl
rm -f ice.ice.000008.tin
rm -f ice.grid.ice.000008
rm -f iceconv.dat.ice.000008
rm -f swimsol.ice.000008
rm -f grid.ice.000009
rm -f ice3dstop.txt.ice.000008
rm -f fensapstop.txt.griddisp.000008
rm -f out.griddisp.000008
rm -f converg.griddisp.000008
rm -f out.remesh.griddisp.000008
rm -f soln.fensap.000009
rm -f surface.dat.fensap.000009
rm -f hflux.dat.fensap.000009
rm -f gmres.out.fensap.000009
rm -f out.fensap.000009
rm -f converg.fensap.000009
rm -f fensapstop.txt.fensap.000009
rm -f droplet.drop.000009
rm -f crystal.drop.000009
rm -f vapor.drop.000009
rm -f gmres.out.drop.000009
rm -f out.drop.000009
rm -f converg.drop.000009
rm -f fensapstop.txt.drop.000009
rm -f swim.log.ice.000009
rm -f map.grid.ice.000009
rm -f timebc.dat.ice.000009
rm -f ice.ice.000009.stl
rm -f ice.ice.000009.tin
rm -f ice.grid.ice.000009
rm -f iceconv.dat.ice.000009
rm -f swimsol.ice.000009
rm -f grid.ice.000010
rm -f ice3dstop.txt.ice.000009
rm -f fensapstop.txt.griddisp.000009
rm -f out.griddisp.000009
rm -f converg.griddisp.000009
rm -f out.remesh.griddisp.000009
rm -f soln.fensap.000010
rm -f surface.dat.fensap.000010
rm -f hflux.dat.fensap.000010
rm -f gmres.out.fensap.000010
rm -f out.fensap.000010
rm -f converg.fensap.000010
rm -f fensapstop.txt.fensap.000010
rm -f droplet.drop.000010
rm -f crystal.drop.000010
rm -f vapor.drop.000010
rm -f gmres.out.drop.000010
rm -f out.drop.000010
rm -f converg.drop.000010
rm -f fensapstop.txt.drop.000010
rm -f swim.log.ice.000010
rm -f map.grid.ice.000010
rm -f timebc.dat.ice.000010
rm -f ice.ice.000010.stl
rm -f ice.ice.000010.tin
rm -f ice.grid.ice.000010
rm -f iceconv.dat.ice.000010
rm -f swimsol.ice.000010
rm -f grid.ice.000011
rm -f ice3dstop.txt.ice.000010
rm -f fensapstop.txt.griddisp.000010
rm -f out.griddisp.000010
rm -f converg.griddisp.000010
rm -f out.remesh.griddisp.000010
rm -f shell.cas
fi

if [ $STEP -eq 0 ]; then
  echo STEP:01_fensap | tee -a .solvercmd.out
  rm -f fensapstop.txt.fensap.000001
  which "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe"
  if [ $? -ne 0 ]; then
    echo ERROR: "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" not available | tee -a .solvercmd.out
  sleep 1
    exit 1
  fi
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.fensap.000001 -s fensapstop.txt.fensap.000001 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.fensap.000001 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=1
  echo 1 > .restart
fi

if [ $STEP -eq 1 ]; then
  echo STEP:01_drop | tee -a .solvercmd.out
  rm -f fensapstop.txt.drop.000001
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.drop.000001 -s fensapstop.txt.drop.000001 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.drop.000001 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=2
  echo 2 > .restart
fi

if [ $STEP -eq 2 ]; then
  echo STEP:01_ice | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -p config.ice.000001 -s ice3dstop.txt.ice.000001 2>&1 | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fensapice/bin/testWaitFileNormally.exe" ice3dstop.txt.ice.000001 .solvercmd.out
  if [ $? -ne 0 ]; then
    echo ERROR:  failed.  Stop. | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=3
  echo 3 > .restart
fi

if [ $STEP -eq 3 ]; then
  echo STEP:Fluent Meshing | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\nti_sh.exe" custom_remeshing.sh ../mesh/GCI.grid grid.ice.000002 map.grid.ice.000001 ice.grid.ice.000001 ice.ice.000001.stl 2>&1 | tee out.remesh.griddisp.000001
  if test ! -f grid.ice.000002
  then
    echo ERROR: Fluent Meshing step failed - grid.ice.000002 is missing | tee -a .solvercmd.out
    sleep 1
    exit 1
  fi
  STEP=4
  echo 4 > .restart
fi

cat out.remesh.griddisp.000001 >> .solvercmd.out
if [ $STEP -eq 4 ]; then
  echo STEP:02_fensap | tee -a .solvercmd.out
  rm -f fensapstop.txt.fensap.000002
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.fensap.000002 -s fensapstop.txt.fensap.000002 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.fensap.000002 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=5
  echo 5 > .restart
fi

if [ $STEP -eq 5 ]; then
  echo STEP:02_drop | tee -a .solvercmd.out
  rm -f fensapstop.txt.drop.000002
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.drop.000002 -s fensapstop.txt.drop.000002 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.drop.000002 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=6
  echo 6 > .restart
fi

if [ $STEP -eq 6 ]; then
  echo STEP:02_ice | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -p config.ice.000002 -s ice3dstop.txt.ice.000002 2>&1 | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fensapice/bin/testWaitFileNormally.exe" ice3dstop.txt.ice.000002 .solvercmd.out
  if [ $? -ne 0 ]; then
    echo ERROR:  failed.  Stop. | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=7
  echo 7 > .restart
fi

if [ $STEP -eq 7 ]; then
  echo STEP:Fluent Meshing | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\nti_sh.exe" custom_remeshing.sh grid.ice.000002 grid.ice.000003 map.grid.ice.000002 ice.grid.ice.000002 ice.ice.000002.stl 2>&1 | tee out.remesh.griddisp.000002
  if test ! -f grid.ice.000003
  then
    echo ERROR: Fluent Meshing step failed - grid.ice.000003 is missing | tee -a .solvercmd.out
    sleep 1
    exit 1
  fi
  STEP=8
  echo 8 > .restart
fi

cat out.remesh.griddisp.000002 >> .solvercmd.out
if [ $STEP -eq 8 ]; then
  echo STEP:03_fensap | tee -a .solvercmd.out
  rm -f fensapstop.txt.fensap.000003
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.fensap.000003 -s fensapstop.txt.fensap.000003 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.fensap.000003 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=9
  echo 9 > .restart
fi

if [ $STEP -eq 9 ]; then
  echo STEP:03_drop | tee -a .solvercmd.out
  rm -f fensapstop.txt.drop.000003
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.drop.000003 -s fensapstop.txt.drop.000003 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.drop.000003 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=10
  echo 10 > .restart
fi

if [ $STEP -eq 10 ]; then
  echo STEP:03_ice | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -p config.ice.000003 -s ice3dstop.txt.ice.000003 2>&1 | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fensapice/bin/testWaitFileNormally.exe" ice3dstop.txt.ice.000003 .solvercmd.out
  if [ $? -ne 0 ]; then
    echo ERROR:  failed.  Stop. | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=11
  echo 11 > .restart
fi

if [ $STEP -eq 11 ]; then
  echo STEP:Fluent Meshing | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\nti_sh.exe" custom_remeshing.sh grid.ice.000003 grid.ice.000004 map.grid.ice.000003 ice.grid.ice.000003 ice.ice.000003.stl 2>&1 | tee out.remesh.griddisp.000003
  if test ! -f grid.ice.000004
  then
    echo ERROR: Fluent Meshing step failed - grid.ice.000004 is missing | tee -a .solvercmd.out
    sleep 1
    exit 1
  fi
  STEP=12
  echo 12 > .restart
fi

cat out.remesh.griddisp.000003 >> .solvercmd.out
if [ $STEP -eq 12 ]; then
  echo STEP:04_fensap | tee -a .solvercmd.out
  rm -f fensapstop.txt.fensap.000004
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.fensap.000004 -s fensapstop.txt.fensap.000004 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.fensap.000004 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=13
  echo 13 > .restart
fi

if [ $STEP -eq 13 ]; then
  echo STEP:04_drop | tee -a .solvercmd.out
  rm -f fensapstop.txt.drop.000004
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.drop.000004 -s fensapstop.txt.drop.000004 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.drop.000004 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=14
  echo 14 > .restart
fi

if [ $STEP -eq 14 ]; then
  echo STEP:04_ice | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -p config.ice.000004 -s ice3dstop.txt.ice.000004 2>&1 | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fensapice/bin/testWaitFileNormally.exe" ice3dstop.txt.ice.000004 .solvercmd.out
  if [ $? -ne 0 ]; then
    echo ERROR:  failed.  Stop. | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=15
  echo 15 > .restart
fi

if [ $STEP -eq 15 ]; then
  echo STEP:Fluent Meshing | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\nti_sh.exe" custom_remeshing.sh grid.ice.000004 grid.ice.000005 map.grid.ice.000004 ice.grid.ice.000004 ice.ice.000004.stl 2>&1 | tee out.remesh.griddisp.000004
  if test ! -f grid.ice.000005
  then
    echo ERROR: Fluent Meshing step failed - grid.ice.000005 is missing | tee -a .solvercmd.out
    sleep 1
    exit 1
  fi
  STEP=16
  echo 16 > .restart
fi

cat out.remesh.griddisp.000004 >> .solvercmd.out
if [ $STEP -eq 16 ]; then
  echo STEP:05_fensap | tee -a .solvercmd.out
  rm -f fensapstop.txt.fensap.000005
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.fensap.000005 -s fensapstop.txt.fensap.000005 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.fensap.000005 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=17
  echo 17 > .restart
fi

if [ $STEP -eq 17 ]; then
  echo STEP:05_drop | tee -a .solvercmd.out
  rm -f fensapstop.txt.drop.000005
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.drop.000005 -s fensapstop.txt.drop.000005 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.drop.000005 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=18
  echo 18 > .restart
fi

if [ $STEP -eq 18 ]; then
  echo STEP:05_ice | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -p config.ice.000005 -s ice3dstop.txt.ice.000005 2>&1 | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fensapice/bin/testWaitFileNormally.exe" ice3dstop.txt.ice.000005 .solvercmd.out
  if [ $? -ne 0 ]; then
    echo ERROR:  failed.  Stop. | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=19
  echo 19 > .restart
fi

if [ $STEP -eq 19 ]; then
  echo STEP:Fluent Meshing | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\nti_sh.exe" custom_remeshing.sh grid.ice.000005 grid.ice.000006 map.grid.ice.000005 ice.grid.ice.000005 ice.ice.000005.stl 2>&1 | tee out.remesh.griddisp.000005
  if test ! -f grid.ice.000006
  then
    echo ERROR: Fluent Meshing step failed - grid.ice.000006 is missing | tee -a .solvercmd.out
    sleep 1
    exit 1
  fi
  STEP=20
  echo 20 > .restart
fi

cat out.remesh.griddisp.000005 >> .solvercmd.out
if [ $STEP -eq 20 ]; then
  echo STEP:06_fensap | tee -a .solvercmd.out
  rm -f fensapstop.txt.fensap.000006
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.fensap.000006 -s fensapstop.txt.fensap.000006 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.fensap.000006 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=21
  echo 21 > .restart
fi

if [ $STEP -eq 21 ]; then
  echo STEP:06_drop | tee -a .solvercmd.out
  rm -f fensapstop.txt.drop.000006
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.drop.000006 -s fensapstop.txt.drop.000006 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.drop.000006 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=22
  echo 22 > .restart
fi

if [ $STEP -eq 22 ]; then
  echo STEP:06_ice | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -p config.ice.000006 -s ice3dstop.txt.ice.000006 2>&1 | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fensapice/bin/testWaitFileNormally.exe" ice3dstop.txt.ice.000006 .solvercmd.out
  if [ $? -ne 0 ]; then
    echo ERROR:  failed.  Stop. | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=23
  echo 23 > .restart
fi

if [ $STEP -eq 23 ]; then
  echo STEP:Fluent Meshing | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\nti_sh.exe" custom_remeshing.sh grid.ice.000006 grid.ice.000007 map.grid.ice.000006 ice.grid.ice.000006 ice.ice.000006.stl 2>&1 | tee out.remesh.griddisp.000006
  if test ! -f grid.ice.000007
  then
    echo ERROR: Fluent Meshing step failed - grid.ice.000007 is missing | tee -a .solvercmd.out
    sleep 1
    exit 1
  fi
  STEP=24
  echo 24 > .restart
fi

cat out.remesh.griddisp.000006 >> .solvercmd.out
if [ $STEP -eq 24 ]; then
  echo STEP:07_fensap | tee -a .solvercmd.out
  rm -f fensapstop.txt.fensap.000007
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.fensap.000007 -s fensapstop.txt.fensap.000007 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.fensap.000007 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=25
  echo 25 > .restart
fi

if [ $STEP -eq 25 ]; then
  echo STEP:07_drop | tee -a .solvercmd.out
  rm -f fensapstop.txt.drop.000007
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.drop.000007 -s fensapstop.txt.drop.000007 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.drop.000007 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=26
  echo 26 > .restart
fi

if [ $STEP -eq 26 ]; then
  echo STEP:07_ice | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -p config.ice.000007 -s ice3dstop.txt.ice.000007 2>&1 | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fensapice/bin/testWaitFileNormally.exe" ice3dstop.txt.ice.000007 .solvercmd.out
  if [ $? -ne 0 ]; then
    echo ERROR:  failed.  Stop. | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=27
  echo 27 > .restart
fi

if [ $STEP -eq 27 ]; then
  echo STEP:Fluent Meshing | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\nti_sh.exe" custom_remeshing.sh grid.ice.000007 grid.ice.000008 map.grid.ice.000007 ice.grid.ice.000007 ice.ice.000007.stl 2>&1 | tee out.remesh.griddisp.000007
  if test ! -f grid.ice.000008
  then
    echo ERROR: Fluent Meshing step failed - grid.ice.000008 is missing | tee -a .solvercmd.out
    sleep 1
    exit 1
  fi
  STEP=28
  echo 28 > .restart
fi

cat out.remesh.griddisp.000007 >> .solvercmd.out
if [ $STEP -eq 28 ]; then
  echo STEP:08_fensap | tee -a .solvercmd.out
  rm -f fensapstop.txt.fensap.000008
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.fensap.000008 -s fensapstop.txt.fensap.000008 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.fensap.000008 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=29
  echo 29 > .restart
fi

if [ $STEP -eq 29 ]; then
  echo STEP:08_drop | tee -a .solvercmd.out
  rm -f fensapstop.txt.drop.000008
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.drop.000008 -s fensapstop.txt.drop.000008 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.drop.000008 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=30
  echo 30 > .restart
fi

if [ $STEP -eq 30 ]; then
  echo STEP:08_ice | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -p config.ice.000008 -s ice3dstop.txt.ice.000008 2>&1 | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fensapice/bin/testWaitFileNormally.exe" ice3dstop.txt.ice.000008 .solvercmd.out
  if [ $? -ne 0 ]; then
    echo ERROR:  failed.  Stop. | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=31
  echo 31 > .restart
fi

if [ $STEP -eq 31 ]; then
  echo STEP:Fluent Meshing | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\nti_sh.exe" custom_remeshing.sh grid.ice.000008 grid.ice.000009 map.grid.ice.000008 ice.grid.ice.000008 ice.ice.000008.stl 2>&1 | tee out.remesh.griddisp.000008
  if test ! -f grid.ice.000009
  then
    echo ERROR: Fluent Meshing step failed - grid.ice.000009 is missing | tee -a .solvercmd.out
    sleep 1
    exit 1
  fi
  STEP=32
  echo 32 > .restart
fi

cat out.remesh.griddisp.000008 >> .solvercmd.out
if [ $STEP -eq 32 ]; then
  echo STEP:09_fensap | tee -a .solvercmd.out
  rm -f fensapstop.txt.fensap.000009
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.fensap.000009 -s fensapstop.txt.fensap.000009 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.fensap.000009 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=33
  echo 33 > .restart
fi

if [ $STEP -eq 33 ]; then
  echo STEP:09_drop | tee -a .solvercmd.out
  rm -f fensapstop.txt.drop.000009
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.drop.000009 -s fensapstop.txt.drop.000009 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.drop.000009 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=34
  echo 34 > .restart
fi

if [ $STEP -eq 34 ]; then
  echo STEP:09_ice | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -p config.ice.000009 -s ice3dstop.txt.ice.000009 2>&1 | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fensapice/bin/testWaitFileNormally.exe" ice3dstop.txt.ice.000009 .solvercmd.out
  if [ $? -ne 0 ]; then
    echo ERROR:  failed.  Stop. | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=35
  echo 35 > .restart
fi

if [ $STEP -eq 35 ]; then
  echo STEP:Fluent Meshing | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\nti_sh.exe" custom_remeshing.sh grid.ice.000009 grid.ice.000010 map.grid.ice.000009 ice.grid.ice.000009 ice.ice.000009.stl 2>&1 | tee out.remesh.griddisp.000009
  if test ! -f grid.ice.000010
  then
    echo ERROR: Fluent Meshing step failed - grid.ice.000010 is missing | tee -a .solvercmd.out
    sleep 1
    exit 1
  fi
  STEP=36
  echo 36 > .restart
fi

cat out.remesh.griddisp.000009 >> .solvercmd.out
if [ $STEP -eq 36 ]; then
  echo STEP:10_fensap | tee -a .solvercmd.out
  rm -f fensapstop.txt.fensap.000010
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.fensap.000010 -s fensapstop.txt.fensap.000010 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.fensap.000010 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=37
  echo 37 > .restart
fi

if [ $STEP -eq 37 ]; then
  echo STEP:10_drop | tee -a .solvercmd.out
  rm -f fensapstop.txt.drop.000010
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -f files.drop.000010 -s fensapstop.txt.drop.000010 2>&1 | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\testWaitFileNormally" fensapstop.txt.drop.000010 .solvercmd.out NORMALLY,normally
  if [ $? != 0 ]; then
    echo ERROR: FENSAP did not complete successfully | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=38
  echo 38 > .restart
fi

if [ $STEP -eq 38 ]; then
  echo STEP:10_ice | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fluent/fluent25.1.0/multiport/mpi/win64/intel/bin/mpiexec.exe" -localonly -np {{ N_CPU }} "C:/Program Files/ANSYS Inc/v251/fensapice/bin_mpi/fensapMPI.exe" -p config.ice.000010 -s ice3dstop.txt.ice.000010 2>&1 | tee -a .solvercmd.out
  "C:/Program Files/ANSYS Inc/v251/fensapice/bin/testWaitFileNormally.exe" ice3dstop.txt.ice.000010 .solvercmd.out
  if [ $? -ne 0 ]; then
    echo ERROR:  failed.  Stop. | tee -a .solvercmd.out
    sleep 1
  exit 1
  fi
  STEP=39
  echo 39 > .restart
fi

if [ $STEP -eq 39 ]; then
  echo STEP:Fluent Meshing | tee -a .solvercmd.out
  "C:\Program Files\ANSYS Inc\v251\fensapice\bin\nti_sh.exe" custom_remeshing.sh grid.ice.000010 grid.ice.000011 map.grid.ice.000010 ice.grid.ice.000010 ice.ice.000010.stl 2>&1 | tee out.remesh.griddisp.000010
  if test ! -f grid.ice.000011
  then
    echo ERROR: Fluent Meshing step failed - grid.ice.000011 is missing | tee -a .solvercmd.out
    sleep 1
    exit 1
  fi
  rm -f .restart
fi

cat out.remesh.griddisp.000010 >> .solvercmd.out
